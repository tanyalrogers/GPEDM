<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Choosing Embedding Parameters • GPEDM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Choosing Embedding Parameters">
<meta property="og:description" content="GPEDM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GPEDM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9008</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="https://github.com/tanyalrogers/GPEDM" class="external-link">Source Code</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Choosing Embedding Parameters</h1>
            
      
      
      <div class="hidden name"><code>choosingE.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tanyalrogers.github.io/GPEDM">GPEDM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>One of the most common questions we get is how to choose the
embedding dimension <span class="math inline">\(E\)</span> and time
delay <span class="math inline">\(\tau\)</span> for a given time series.
There is, unfortunately, no one correct way to do this. We detail below
some general guidelines and different approaches that can be used to
select these values.</p>
<p>The <em>maximum</em> embedding dimension that can be estimated for a
time series of length <span class="math inline">\(T\)</span> is
approximately <span class="math inline">\(\sqrt{T}\)</span> (Cheng and
Tong 1992), so the largest <span class="math inline">\(E\)</span>
considered should not exceed this too greatly. The actual attractor
dimension of the system may be higher, but the dimension you’re going to
be able to resolve will be limited by time series length. You also may
have valid reasons to limit the largest <span class="math inline">\(E\)</span> considered to something less than <span class="math inline">\(\sqrt{T}\)</span>. Note that in multivariate
models (e.g. those with covariates) <span class="math inline">\(E\)</span> is the total number of predictors
including lags, covariates, and lags of covariates. The total number of
predictors should not exceed <span class="math inline">\(\sqrt{T}\)</span>, meaning you may need to use
fewer lags if you add covariates to the model. For example, <span class="math inline">\(\{x_{t-1},x_{t-2},x_{t-3}\}\)</span>, <span class="math inline">\(\{x_{t-1},x_{t-2},y_{t-1}\}\)</span>, and <span class="math inline">\(\{x_{t-1},y_{t-1},z_{t-1}\}\)</span> are all
3-dimensional embeddings (<span class="math inline">\(E=3\)</span>).</p>
<p>In terms of selecting <span class="math inline">\(\tau\)</span>,
fixing it to 1 can be a completely justifiable approach, particularly if
your sampling interval is coarse relative to the dynamics of the system.
However, if the sampling interval is fine, or the timescale of dynamics
uncertain, you might wish to explore other values of <span class="math inline">\(\tau\)</span>. The generation time of the species
under study (if longer than the sampling interval) can sometimes provide
a good ballpark estimate for <span class="math inline">\(\tau\)</span>.
However, keep in mind that <span class="math inline">\(E\tau\)</span>
data points will always be lost from the beginning of the time series,
and obviously, the product <span class="math inline">\(E\tau\)</span>
cannot be larger than <span class="math inline">\(T\)</span> (or in the
case of multiple populations, larger than the shortest within-population
time series length). You might wish to set some threshold for the
product <span class="math inline">\(E\tau\)</span> relative to <span class="math inline">\(T\)</span>, so that you end up with a sufficient
number of valid delay vectors. For instance, when evaluating possible
<span class="math inline">\(E\)</span> and <span class="math inline">\(\tau\)</span> values for S-map EDM, Rogers et
al. (2022) required <span class="math inline">\(E≤\sqrt{T}\)</span> and
<span class="math inline">\(E\tau≤0.2T\)</span> (i.e. you cannot remove
more than 20% of the data points).</p>
<p>Once you have identified a space of reasonable <span class="math inline">\(E\)</span> and <span class="math inline">\(\tau\)</span> combinations to consider, there are
a variety of methods you can use to select them (either independently or
jointly). The supplement of Rogers et al. (2022) details several of
these methods and their performance on simulated data with known <span class="math inline">\(E\)</span> and <span class="math inline">\(\tau\)</span>. They found that the best method for
S-map EDM was based on model forecast performance evaluated over a grid.
GP-EDM, because it includes automatic relevance determination (ARD),
enables some additional strategies for choosing <span class="math inline">\(E\)</span> and <span class="math inline">\(\tau\)</span>. ARD eliminates uniformative lags,
so can be used (in theory) to automatically identify <span class="math inline">\(E\)</span> and choose the relevant time lags.</p>
<p>We present a few possible methods below, which are based on model
performance. Note that performance must be evaluated
<em>out-of-sample</em>, e.g. using leave-one-out cross validation, a
training/test split, or some other method (which method to use will
depend on how much data you have). In-sample performance will always
increase as <span class="math inline">\(E\)</span> increases, but
out-of-sample performance will cease to improve substantially once the
optimal <span class="math inline">\(E\)</span> is reached.</p>
<p>Because real data are rarely as cooperative as models, we present
both a model example (noise-free, 3 species Hastings-Powell model) and a
real data example (shortfin squid mean catch-per-unit-effort from a
bottom trawl survey in the Gulf of Maine) for each method.</p>
</div>
<div class="section level2">
<h2 id="grid-search-method">1. Grid search method<a class="anchor" aria-label="anchor" href="#grid-search-method"></a>
</h2>
<p>Evaluate all possible models and select the best performing. For
instance, Rogers et al. (2022) found that the best approach in S-map EDM
was to evaluate all possible combinations of <span class="math inline">\(E\)</span>, <span class="math inline">\(\tau\)</span>, and the S-map local weighting
parameter <span class="math inline">\(\theta\)</span> and choose the one
with the highest out-of-sample <span class="math inline">\(R^2\)</span>.
Recognizing that multiple models can have identical or near identical
fits, they considered any models that differed by less than 0.01 in
<span class="math inline">\(R^2\)</span> to be equivalent, and selected
among the highest-performing equivalent models, the one with the lowest
<span class="math inline">\(\tau\)</span>, <span class="math inline">\(\theta\)</span>, and <span class="math inline">\(E\)</span> (in that order), so as to prioritize
simpler, more linear models. One could use other thresholds or criteria
for ‘equivalency’ than this one though. Determining which models are
equivalent and ranking them is particularly relevant for model data with
little to no noise, where many different models can have high fit
statistics, but can happen with real data as well, where there is not a
clear ‘winner’ among the candidate models.</p>
<p>In the context of GP-EDM, there is no <span class="math inline">\(\theta\)</span> to estimate: the inverse length
scales (<code>phi</code> values) determine the curvature similarly to
‘local weighting’ parameters, but there is one <code>phi</code> for each
input (rather than one <span class="math inline">\(\theta\)</span> for
all inputs) and the values are optimized in each model. Thus, <span class="math inline">\(E\)</span> and <span class="math inline">\(\tau\)</span> are the only hyperparameters that
need to be determined.</p>
<div class="section level4">
<h4 id="hastings-powell-model">Hastings Powell model<a class="anchor" aria-label="anchor" href="#hastings-powell-model"></a>
</h4>
<p>Since we have plenty of simulated data, we’ll split the time series
into a training and testing set, each of 200 points. To ensure that the
out-of-sample <span class="math inline">\(R^2\)</span> is evaluated over
the same test set regardless of <span class="math inline">\(E\)</span>
and <span class="math inline">\(\tau\)</span> (the first <span class="math inline">\(E\tau\)</span> points of the test dataset are not
eliminated), we generate the lags beforehand (see the last example in <a href="https://tanyalrogers.github.io/GPEDM/index.html#other-types-of-predictions">this
section</a> of the readme). With 200 points, we could consider <span class="math inline">\(E\)</span> up to 14, but since we know that is far
higher than necessary for this model system, we’ll set max <span class="math inline">\(E\)</span> to 8 to save some time.</p>
<p>We find that <span class="math inline">\(E=2\)</span> and <span class="math inline">\(\tau=1\)</span> are sufficient here. This is a
continuous time model with an integration step size of 1, so it is also
not surprising that higher <span class="math inline">\(\tau\)</span>
values work well as long as <span class="math inline">\(E\)</span> is at
least 2.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#we'll just consider the X variable</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/qplot.html" class="external-link">qplot</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">X</span>, x<span class="op">=</span><span class="va">Time</span>, data<span class="op">=</span><span class="va">HastPow3sp</span>, geom <span class="op">=</span> <span class="st">"line"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `qplot()` was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; This warning is displayed once every 8 hours.</span></span>
<span><span class="co">#&gt; Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span>
<span><span class="co">#&gt; generated.</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#create grid of E and tau to consider</span></span>
<span><span class="va">Emax</span><span class="op">=</span><span class="fl">8</span></span>
<span><span class="va">taumax</span><span class="op">=</span><span class="fl">3</span></span>
<span><span class="va">Etaugrid</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>E<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">Emax</span>,tau<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">taumax</span><span class="op">)</span></span>
<span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2</span><span class="op">=</span><span class="cn">NA</span></span>
<span></span>
<span><span class="co">#generate all lags</span></span>
<span><span class="va">HPlags</span><span class="op">=</span><span class="fu"><a href="../reference/makelags.html">makelags</a></span><span class="op">(</span><span class="va">HastPow3sp</span>,<span class="st">"X"</span>,E<span class="op">=</span><span class="va">Emax</span><span class="op">*</span><span class="va">taumax</span>, tau<span class="op">=</span><span class="fl">1</span>, append<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#split training and test</span></span>
<span><span class="va">HP_train</span><span class="op">=</span><span class="va">HPlags</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span>,<span class="op">]</span></span>
<span><span class="va">HP_test</span><span class="op">=</span><span class="va">HPlags</span><span class="op">[</span><span class="fl">201</span><span class="op">:</span><span class="fl">400</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co">#loop through the grid</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#fit model with ith combo of E and tau</span></span>
<span>  <span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">HP_train</span>, </span>
<span>             y<span class="op">=</span><span class="st">"X"</span>,</span>
<span>             x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"X_"</span>,<span class="va">Etaugrid</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">E</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             time<span class="op">=</span><span class="st">"Time"</span>, </span>
<span>             newdata <span class="op">=</span> <span class="va">HP_test</span><span class="op">)</span></span>
<span>  <span class="co">#store out of sample R2</span></span>
<span>  <span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">=</span><span class="va">demo</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Etaugrid</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">E</span>, y<span class="op">=</span><span class="va">tau</span>, fill<span class="op">=</span><span class="va">R2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">taumax</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">Emax</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span>, </span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"black"</span>, fill<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-2-2.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2round</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#if not aleady in order</span></span>
<span><span class="co">#Etaugrid=Etaugrid[order(Etaugrid$tau,Etaugrid$E),] </span></span>
<span><span class="op">(</span><span class="va">bestE</span><span class="op">=</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">E</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2round</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">besttau</span><span class="op">=</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2round</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">HP_train</span>, y<span class="op">=</span><span class="st">"X"</span>,</span>
<span>           x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"X_"</span>,<span class="va">besttau</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">bestE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           time<span class="op">=</span><span class="st">"Time"</span>, newdata <span class="op">=</span> <span class="va">HP_test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">demo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 2 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;      predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1       X_1       0.21716</span></span>
<span><span class="co">#&gt; phi2       X_2       0.33140</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.0001761443</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 4.365049</span></span>
<span><span class="co">#&gt; Number of populations: 1</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.9998473 </span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.9979118</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">demo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Plotting out of sample results.</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-2-3.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="squid-data">Squid data<a class="anchor" aria-label="anchor" href="#squid-data"></a>
</h4>
<p>This is 44 year annual time series, thus the max <span class="math inline">\(E\)</span> should be about 6 or 7. The squid
species being sampled has an annual life history, so <code>tau=1</code>
would make the most biological sense. Just for demonstration purposes,
we set the max <span class="math inline">\(\tau\)</span> to 3. To
provide a more complex example in which the predictor and response
variables are different, we will model growth rate as a function of log
abundance (we will need to generate the lags beforehand, option 1 in <a href="https://tanyalrogers.github.io/GPEDM/index.html#specifying-training-data">Specifying
training data</a>). Because the time series is relatively short, we will
use leave-one-out to evaluate performance.</p>
<p>We find that <span class="math inline">\(\tau=1\)</span> is clearly
the best, and <span class="math inline">\(E=6\)</span> produces the best
performance, although only minorly over <span class="math inline">\(E=4\)</span> (they differ in <span class="math inline">\(R^2\)</span> by only 0.0102). You would be
justified in selecting either <span class="math inline">\(E=4\)</span>
or <span class="math inline">\(E=6\)</span>, perhaps going for the
smaller one if you were interested in parsimony.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#we'll just consider one population for this example</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">trawl</span><span class="op">)</span></span>
<span><span class="va">squid</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">trawl</span>,<span class="va">REGION</span><span class="op">==</span><span class="st">"GME"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/qplot.html" class="external-link">qplot</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">shortfin_squid</span>, x<span class="op">=</span><span class="va">YEAR</span>, data<span class="op">=</span><span class="va">squid</span>, geom <span class="op">=</span> <span class="st">"line"</span><span class="op">)</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#growth rate and log abundance</span></span>
<span><span class="va">squid</span><span class="op">$</span><span class="va">squidlog</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">squid</span><span class="op">$</span><span class="va">shortfin_squid</span><span class="op">)</span></span>
<span><span class="va">squid</span><span class="op">$</span><span class="va">squidgr</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">squid</span><span class="op">$</span><span class="va">squidlog</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#time series length</span></span>
<span><span class="va">serlen</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">squid</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#create grid of E and tau to consider</span></span>
<span><span class="va">Emax</span><span class="op">=</span><span class="fl">6</span></span>
<span><span class="va">taumax</span><span class="op">=</span><span class="fl">3</span></span>
<span><span class="va">Etaugrid</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>E<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">Emax</span>,tau<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">taumax</span><span class="op">)</span></span>
<span><span class="co">#remove E and tau combinations that lose too much data (other critera could be used)</span></span>
<span><span class="va">Etaugrid</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Etaugrid</span>, <span class="va">Etaugrid</span><span class="op">$</span><span class="va">E</span><span class="op">^</span><span class="fl">2</span><span class="op">&lt;=</span><span class="va">serlen</span> <span class="op">&amp;</span> <span class="va">Etaugrid</span><span class="op">$</span><span class="va">E</span><span class="op">*</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">tau</span><span class="op">/</span><span class="va">serlen</span><span class="op">&lt;=</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2</span><span class="op">=</span><span class="cn">NA</span></span>
<span></span>
<span><span class="co">#generate all lags</span></span>
<span><span class="va">squidlags</span><span class="op">=</span><span class="fu"><a href="../reference/makelags.html">makelags</a></span><span class="op">(</span><span class="va">squid</span>,<span class="st">"squidlog"</span>,E<span class="op">=</span><span class="va">Emax</span><span class="op">*</span><span class="va">taumax</span>, tau<span class="op">=</span><span class="fl">1</span>, append<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#loop through the grid</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#fit model with ith combo of E and tau</span></span>
<span>  <span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">squidlags</span>, </span>
<span>             y<span class="op">=</span><span class="st">"squidgr"</span>,</span>
<span>             x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"squidlog_"</span>,<span class="va">Etaugrid</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">E</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             time<span class="op">=</span><span class="st">"YEAR"</span>, </span>
<span>             predictmethod <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span></span>
<span>  <span class="co">#store out of sample R2</span></span>
<span>  <span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">=</span><span class="va">demo</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Etaugrid</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">E</span>, y<span class="op">=</span><span class="va">tau</span>, fill<span class="op">=</span><span class="va">R2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">taumax</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">Emax</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span>, </span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"black"</span>, fill<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2round</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#if not aleady in order</span></span>
<span><span class="co">#Etaugrid=Etaugrid[order(Etaugrid$tau,Etaugrid$E),] </span></span>
<span><span class="op">(</span><span class="va">bestE</span><span class="op">=</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">E</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2round</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">besttau</span><span class="op">=</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">Etaugrid</span><span class="op">$</span><span class="va">R2round</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">squidlags</span>, y<span class="op">=</span><span class="st">"squidgr"</span>, </span>
<span>           x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"squidlog_"</span>,<span class="va">besttau</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">bestE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           time<span class="op">=</span><span class="st">"YEAR"</span>, </span>
<span>           predictmethod <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">demo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 6 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;       predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1 squidlog_1       0.04734</span></span>
<span><span class="co">#&gt; phi2 squidlog_2       0.24373</span></span>
<span><span class="co">#&gt; phi3 squidlog_3       0.06569</span></span>
<span><span class="co">#&gt; phi4 squidlog_4       0.00746</span></span>
<span><span class="co">#&gt; phi5 squidlog_5       0.02067</span></span>
<span><span class="co">#&gt; phi6 squidlog_6       0.00130</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.203274</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 2.647853</span></span>
<span><span class="co">#&gt; Number of populations: 1</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.8892768 </span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.5833364</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">demo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Plotting out of sample results.</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-3-3.png" width="700"></p>
<p>This grid search method of selecting models, while thorough, can be
very time consuming. There are some potentially more efficient ways to
arrive at the same answer, described below.</p>
</div>
</div>
<div class="section level2">
<h2 id="increase-e-method">2. Increase E method<a class="anchor" aria-label="anchor" href="#increase-e-method"></a>
</h2>
<p>Increase <span class="math inline">\(E\)</span> until performance no
longer increases substantially (fixing <span class="math inline">\(\tau\)</span> to 1 or some other reasonable
minimum value). ARD will drop lags that are uninformative (set
<code>phi</code> to 0 for those lags), allowing for a larger ‘realized’
<span class="math inline">\(\tau\)</span>, as well as unequal lag
spacing. You might notice that the set of relevant lags changes as <span class="math inline">\(E\)</span> increases (e.g. lag 2 is important when
<span class="math inline">\(E=2\)</span>, but not when <span class="math inline">\(E=4\)</span>). This behavior is normal and occurs
because lags sometimes provide redundant information, and thus the model
will identify different lags as relevant depending on the set
available.</p>
<p>Once you identify the <span class="math inline">\(E\)</span> with the
best performance, should you go back and drop lags that were deemed
uninformative (had <code>phi</code> values of 0)? You could do this if
you want, though it’s not strictly necessary. This would result in a
model with a smaller ‘realized’ <span class="math inline">\(E\)</span>
and some mixture of lag spacing. The model performance will probably not
change; however, beware that lags with small but non-zero
<code>phi</code> values can sometimes be influential, and performance
might decline if they are excluded. The <code>summary</code> function
rounds <code>phi</code> values, so values that appear to be 0 might not
actually be.</p>
<div class="section level4">
<h4 id="hastings-powell-model-1">Hastings Powell model<a class="anchor" aria-label="anchor" href="#hastings-powell-model-1"></a>
</h4>
<p>Here, we can clearly see that <span class="math inline">\(E=2\)</span> is sufficient.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Emax</span><span class="op">=</span><span class="fl">8</span></span>
<span><span class="va">R2vals</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">Emax</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Emax</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">HP_train</span>, y<span class="op">=</span><span class="st">"X"</span>,</span>
<span>             x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"X_"</span>,<span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">i</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             time<span class="op">=</span><span class="st">"Time"</span>, newdata <span class="op">=</span> <span class="va">HP_test</span><span class="op">)</span></span>
<span>  <span class="va">R2vals</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">=</span><span class="va">demo</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span></span>
<span>  <span class="co">#print(i)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">demo</span><span class="op">$</span><span class="va">pars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">i</span><span class="op">]</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;     phi1 </span></span>
<span><span class="co">#&gt; 0.020154 </span></span>
<span><span class="co">#&gt;     phi1     phi2 </span></span>
<span><span class="co">#&gt; 0.217163 0.331399 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3 </span></span>
<span><span class="co">#&gt; 0.063912 0.056489 0.011711 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4 </span></span>
<span><span class="co">#&gt; 0.066353 0.049745 0.000000 0.004594 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4     phi5 </span></span>
<span><span class="co">#&gt; 0.056124 0.000000 0.038560 0.000000 0.008030 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4     phi5     phi6 </span></span>
<span><span class="co">#&gt; 0.055719 0.000000 0.037928 0.000000 0.008687 0.000000 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4     phi5     phi6     phi7 </span></span>
<span><span class="co">#&gt; 0.055749 0.000000 0.038347 0.000000 0.008479 0.000000 0.000000 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4     phi5     phi6     phi7     phi8 </span></span>
<span><span class="co">#&gt; 0.046518 0.000000 0.000471 0.000471 0.033521 0.012773 0.002145 0.000000</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Emax</span>, <span class="va">R2vals</span>, type<span class="op">=</span><span class="st">"o"</span><span class="op">)</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="squid-data-1">Squid data<a class="anchor" aria-label="anchor" href="#squid-data-1"></a>
</h4>
<p>As before, you would be justified in selecting either <span class="math inline">\(E=4\)</span> or <span class="math inline">\(E=6\)</span> in this case. We can see that the
inverse length scale <code>phi</code> for lag 6 is quite small, so it is
not providing much information.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Emax</span><span class="op">=</span><span class="fl">6</span></span>
<span><span class="va">squidlags</span><span class="op">=</span><span class="fu"><a href="../reference/makelags.html">makelags</a></span><span class="op">(</span><span class="va">squid</span>,<span class="st">"squidlog"</span>,E<span class="op">=</span><span class="va">Emax</span>, tau<span class="op">=</span><span class="fl">1</span>, append <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">R2vals</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">Emax</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">Emax</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">squidlags</span>, </span>
<span>             y<span class="op">=</span><span class="st">"squidgr"</span>,</span>
<span>             x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"squidlog_"</span>,<span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">i</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             time<span class="op">=</span><span class="st">"YEAR"</span>, </span>
<span>             predictmethod <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span></span>
<span>  <span class="va">R2vals</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">=</span><span class="va">demo</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span></span>
<span>  <span class="co">#print(i)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">demo</span><span class="op">$</span><span class="va">pars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">i</span><span class="op">]</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;     phi1 </span></span>
<span><span class="co">#&gt; 0.035776 </span></span>
<span><span class="co">#&gt;     phi1     phi2 </span></span>
<span><span class="co">#&gt; 0.035482 0.000000 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3 </span></span>
<span><span class="co">#&gt; 0.046410 0.193942 0.031216 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4 </span></span>
<span><span class="co">#&gt; 0.061337 0.292041 0.044430 0.124112 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4     phi5 </span></span>
<span><span class="co">#&gt; 0.062538 0.307994 0.049649 0.077748 0.000000 </span></span>
<span><span class="co">#&gt;     phi1     phi2     phi3     phi4     phi5     phi6 </span></span>
<span><span class="co">#&gt; 0.047337 0.243734 0.065694 0.007457 0.020671 0.001297</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Emax</span>, <span class="va">R2vals</span>, type<span class="op">=</span><span class="st">"o"</span><span class="op">)</span></span></code></pre></div>
<p><img src="choosingE_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="max-e-method">3. Max E method<a class="anchor" aria-label="anchor" href="#max-e-method"></a>
</h2>
<p>Set <span class="math inline">\(E\)</span> to the maximum value
(fixing <span class="math inline">\(\tau\)</span> to 1 or some other
reasonable minimum value), and let ARD eliminate all lags that are
uninformative. Because performance plateaus, performance of the
resulting model will be equivalent to model with the optimal <span class="math inline">\(E\)</span>. Pros: You only have to fit one model.
Cons: The model may include more lag predictors than are strictly
necessary, and you may be eliminating more training data points (product
<span class="math inline">\(E\tau\)</span>) than are necessary. You
could look at the inverse length scales from the “max E” model, and if
you see all lags above some <span class="math inline">\(E^*\)</span>
have values of 0, then <span class="math inline">\(E^*\)</span> is the
embedding dimension, and you would be justified in refitting the model
with higher lags removed (performance should not change, because the
higher lags weren’t contributing anything). This doesn’t always happen
though.</p>
<div class="section level4">
<h4 id="hastings-powell-model-2">Hastings Powell model<a class="anchor" aria-label="anchor" href="#hastings-powell-model-2"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Emax</span><span class="op">=</span><span class="fl">8</span></span>
<span><span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">HP_train</span>, y<span class="op">=</span><span class="st">"X"</span>, x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"X_"</span>,<span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Emax</span><span class="op">)</span><span class="op">)</span>, time<span class="op">=</span><span class="st">"Time"</span>, newdata <span class="op">=</span> <span class="va">HP_test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">demo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 8 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;      predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1       X_1       0.04652</span></span>
<span><span class="co">#&gt; phi2       X_2       0.00000</span></span>
<span><span class="co">#&gt; phi3       X_3       0.00047</span></span>
<span><span class="co">#&gt; phi4       X_4       0.00047</span></span>
<span><span class="co">#&gt; phi5       X_5       0.03352</span></span>
<span><span class="co">#&gt; phi6       X_6       0.01277</span></span>
<span><span class="co">#&gt; phi7       X_7       0.00214</span></span>
<span><span class="co">#&gt; phi8       X_8       0.00000</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.0001000025</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 4.087007</span></span>
<span><span class="co">#&gt; Number of populations: 1</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.9999973 </span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.9998047</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="squid-data-2">Squid data<a class="anchor" aria-label="anchor" href="#squid-data-2"></a>
</h4>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Emax</span><span class="op">=</span><span class="fl">6</span></span>
<span><span class="va">demo</span><span class="op">=</span><span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">squidlags</span>, y<span class="op">=</span><span class="st">"squidgr"</span>, x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"squidlog_"</span>,<span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Emax</span><span class="op">)</span><span class="op">)</span>, </span>
<span>           time<span class="op">=</span><span class="st">"YEAR"</span>, predictmethod <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">demo</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 6 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;       predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1 squidlog_1       0.04734</span></span>
<span><span class="co">#&gt; phi2 squidlog_2       0.24373</span></span>
<span><span class="co">#&gt; phi3 squidlog_3       0.06569</span></span>
<span><span class="co">#&gt; phi4 squidlog_4       0.00746</span></span>
<span><span class="co">#&gt; phi5 squidlog_5       0.02067</span></span>
<span><span class="co">#&gt; phi6 squidlog_6       0.00130</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.203274</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 2.647853</span></span>
<span><span class="co">#&gt; Number of populations: 1</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.8892768 </span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.5833364</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="inconsistency-ambiguity-and-getting-the-right-answer">Inconsistency, ambiguity, and getting the ‘right’ answer<a class="anchor" aria-label="anchor" href="#inconsistency-ambiguity-and-getting-the-right-answer"></a>
</h2>
<p>We suggest not worrying too much about whether you have exactly the
right <span class="math inline">\(E\)</span>, or if the inverse length
scales vary among models. Many delay embedding models can have
equivalent performance (particularly with multivariate predictors), and
there is often no way to tell which is the ‘right’ one. Ideally, your
results should be robust to minor differences in <span class="math inline">\(E\)</span>, and you can conduct a sensitivity
analysis if you are concerned. If you’re wanting to make
<em>inference</em> based on the hyperparameters, including <span class="math inline">\(E\)</span> and the inverse length scales, more
care should be taken in terms of model selection. If all you care about
is forecasting, it’s not worth fussing over too much, and the “max E”
approach might be sufficient.</p>
<p>There is no formula, so if in doubt, try multiple approaches and see
what you get. Sometimes you have to make a judgement call based on what
seems the most reasonable or parsimonious for your analysis goals.</p>
</div>
<div class="section level2">
<h2 id="best-practices-and-common-pitfalls">Best practices and common pitfalls<a class="anchor" aria-label="anchor" href="#best-practices-and-common-pitfalls"></a>
</h2>
<ul>
<li><p>Always plot your time series (training and test) before fitting a
model.</p></li>
<li><p>Do not forget the <code>pop</code> argument when generating lags
for multi-population data, otherwise there will be crossover between
time series.</p></li>
<li><p>Poor or strange results can be obtained if the test dataset is
too short, has insufficient variance, or is very inconsistent among
candidate models. Inconsistency usually arises due to the first <span class="math inline">\(E\tau\)</span> timepoints being removed as <span class="math inline">\(E\)</span> and <span class="math inline">\(\tau\)</span> change, which for short test time
series, can result in substantial changes to the baseline variance of
the values being predicted across candidate models.</p></li>
<li><p>When you have multiple populations, you have to consider the time
series length within populations, as well as the number of delay vectors
across all populations, when thinking about how much training/test data
you have for a given <span class="math inline">\(E\)</span> and <span class="math inline">\(\tau\)</span> value.</p></li>
<li><p>You may find that performance results differ depending on the
train/test split used. Consider using <code>loo</code>,
<code>lto</code>, or <code>sequential</code> sampling in these cases
instead of a split, particularly for short time series, or another form
of n-fold cross validation.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Cheng B, Tong H (1992) On consistent nonparametric order
determination and chaos. J. R. Stat. Soc. Ser. B 54, 427–449</p>
<p>Rogers TL, Johnson BJ, Munch SB (2022) Chaos is not rare in natural
ecosystems. Nature Ecology and Evolution 6:1105–1111</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Stephan Munch, Tanya Rogers.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
