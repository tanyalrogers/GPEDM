<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hierarchical Models and Dynamic Correlation • GPEDM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Hierarchical Models and Dynamic Correlation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GPEDM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9009</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="https://github.com/tanyalrogers/GPEDM" class="external-link">Source Code</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Hierarchical Models and Dynamic Correlation</h1>
            
      

      <div class="hidden name"><code>hierarchical.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tanyalrogers.github.io/GPEDM">GPEDM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Many ecological time series are short relative to the timescale of
the system, which presents a major obstacle to the successful
application of EDM: if the time series does not adequately cover the
range of possible dynamics and make a sufficient number of ‘cycles’
around the attractor, it can be difficult for EDM to make reliable
predictions.</p>
<p>One solution is to leverage multiple (potential short) time series
from replicates with similar dynamics. These could be multiple
replicates in an experiment, populations of the same species from
multiple locations, different life history stages of the same species,
or potentially even multiple species that are suspected to have similar
dynamics. The most common case is likely to be replicate time series
collected for multiple populations of the same species over space, so
we’ll be referring to the replicates as ‘populations’ but these
replicates can represent other things as well.</p>
<p>If you have time series data from multiple populations,
<code>GPEDM</code> includes several options for integrating the data
into a common model, which can potentially lead to better predictions
than models fit to each short time series independently. This approach
requires that the delay embedding maps are similar across populations
(usually a reasonable assumption for populations of the same species)
but not strongly synchronized (i.e. each series provides some
independent information).</p>
<p>The hyperparameter <code>rho</code> is the <em>dynamic
correlation</em> in the hierarchical GP model, indicating similarity of
dynamics across populations. In contrast to traditional correlation
metrics (e.g. Pearson correlation), which quantify the similarity of
population fluctuations over time (i.e. synchrony), the dynamic
correlation quantifies the similarity of population responses across
predictor space. The value of <code>rho</code> can be fixed to any value
from 0.0001 to 0.9999 using <code>rhofixed</code>, otherwise it is
estimated from the data. All populations are assumed to have the same
<code>rho</code> value relative to one another. Alternatively, one can
estimate pairwise values of <code>rho</code> between populations and
supply a fixed matrix of <code>rho</code> values
(<code>rhomatrix</code>) to use, rather than a single value.</p>
</div>
<div class="section level2">
<h2 id="scaling-considerations">Scaling considerations<a class="anchor" aria-label="anchor" href="#scaling-considerations"></a>
</h2>
<p>Before fitting any models, you should think about how you want to
standardize the data. When you have multiple populations, scaling the
data within populations (<code>scaling=local</code>) vs. across
populations (<code>scaling=global</code>) can lead to very different
model fits and performance, so it is worth putting some thought into
this. Generally speaking, if the variable has the same units across
populations, you will probably want to use global scaling. If the
variable has different units, you will probably want to use local
scaling. However, you may have valid reasons to deviate from this, and
trying both might be worthwhile if in doubt. For instance, if the
species of interest has different carrying capacities in different
regions, local scaling of dynamics might make more sense, even if the
units are the same. If you have covariates, you might choose to use
different scalings for different variables. (Note
<code>scaling=global</code> and <code>scaling=local</code> apply to all
predictors, whether they’re lags, covariates, or lags of covariates, and
they all are scaled independently of each other.) To use a mix of
scalings, you need to scale the data yourself beforehand and set
<code>scaling="none"</code>. You might get warnings that values are not
scaled properly, which is because generating lags elimiates some data,
so the mean and sd of each predictor may deviate somewhat from 0 and 1.
They should not be too far off though, so this warning can usually be
ignored. Note that if unspecified, scaling in <code>fitGP</code>
defaults to <code>"global"</code>. See the documentation for
<code>fitGP</code> for more information about scaling.</p>
</div>
<div class="section level2">
<h2 id="embedding-considerations">Embedding considerations<a class="anchor" aria-label="anchor" href="#embedding-considerations"></a>
</h2>
<p>For a single population, the maximum value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
considered should not be much larger than the square root of the time
series length. When combining data from multiple populations, you have
more data at your disposal to reconstruct dynamics, and can use
potentially higher values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
than you could for a single population. However,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mi>τ</mi></mrow><annotation encoding="application/x-tex">E\tau</annotation></semantics></math>
cannot be greater than the shortest within-population time series
length, so you may wish to constrain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
in some way to ensure sufficient training data across populations. Note
than when using hierarchical models, all populations will use the same
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>.</p>
</div>
<div class="section level2">
<h2 id="model-evaluation-considerations">Model evaluation considerations<a class="anchor" aria-label="anchor" href="#model-evaluation-considerations"></a>
</h2>
<p>When using multiple populations, there are a few additional things
you need to consider when evaluating model performance. The built-in
leave-one-out routine, <code>predictmethod="loo"</code>, leaves out each
individual datapoint, so datapoints taken at the same time but in a
different location might be included in the training set. If this is of
concern, there is another routine, <code>predictmethod="lto"</code>,
which leaves out all datapoints taken at the same time across all
locations. If there is only one population, these are obviously
equivalent. The routine <code>predictmethod="sequential"</code> leaves
out all future timepoints across all locations. If you decide to use a
training/test split, take care to split each population, not the stacked
series. Predictions cannot be made for populations which do not appear
in the training data.</p>
<p>In addition to comparing different hierarchical structures (described
below), you might also wish to compare the results from models fit to
each population separately. Note that as with all hierarchical models,
the hierarchical structure is a constraint that forces some similarity
of dynamics across populations. Populations in the same hierarchical
model will share the same embedding parameters
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>E</mi><annotation encoding="application/x-tex">E</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>)
and the same inverse length scale parameters (this includes models with
<code>rho=0</code>). This means the hierarchical model is inherently
less flexible than if you were to fit separate models to each population
individually. If each population has a lot of data, <em>the hierarchical
fit might be poorer than fitting a model to each population
individually, due to this decreased flexibility</em>. On the flip side,
if each population does not have much data, or the data are very noisy,
the constraints and pooled information in a hierarchical model can lead
to better performance than individual fits.</p>
<p>Beware of local minima. If the relative performance of models seems
off, or better results are obtained using a fixed <code>rho</code> than
a fitted one, then the model might be getting stuck in a local minima.
One could try using different values of <code>initpars</code>.</p>
<p>It might also be that some populations have very different dynamics
than the others, and you might get better performance by spliting the
populations up into different hierarchical models. This situation might
also contribute to local minima. The pairwise <code>rhomatrix</code>
might be informative here.</p>
</div>
<div class="section level2">
<h2 id="example-dataset">Example dataset<a class="anchor" aria-label="anchor" href="#example-dataset"></a>
</h2>
<p>In our example, we will use log-transformed catch-per-unit-effort
(CPUE) time series for brown shrimp from 9 different regions
(statistical zones) in the Gulf of Mexico. These are annual time series
from the SEAMAP Summer Groundfish Trawl Survey, spanning 33 years.
Plotting the time series, fluctuations in shrimp abundance in each
region appear roughly similar, but have different means, so we decided
to use local scaling in this case. Trying both scalings also showed that
local scaling led to better performance.</p>
<p>In this example, we only use lags of CPUE, but we note that in the
publication from which these data were taken (Tsai et al. 2022), better
predictions were obtained by using environmental and fishery catch data
as covariates. The results here deviate from the results in the paper
because of the absence of these covariates.</p>
<p>When using the hierarchical models, the data must be in long format
with a column for population identifier. Note that populations <em>do
not</em> need to have the same number of observations, or overlapping
time indices, as in this example.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">E</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">scaling</span> <span class="op">=</span> <span class="st">"local"</span></span>
<span></span>
<span><span class="co">#get log abundance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">shrimp</span><span class="op">)</span></span>
<span><span class="va">shrimp</span><span class="op">$</span><span class="va">splog</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shrimp</span><span class="op">$</span><span class="va">cpue</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#generate lags</span></span>
<span><span class="va">splags</span> <span class="op">=</span> <span class="fu"><a href="../reference/makelags.html">makelags</a></span><span class="op">(</span><span class="va">shrimp</span>, y <span class="op">=</span> <span class="st">"splog"</span>, pop <span class="op">=</span> <span class="st">"zone"</span>, E <span class="op">=</span> <span class="va">E</span>, tau <span class="op">=</span> <span class="fl">1</span>, append <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ggplot(shrimp) +</span></span>
<span><span class="co">#   facet_wrap(zone~., scales = "free") +</span></span>
<span><span class="co">#   geom_point(aes(y=cpue, x=year)) + geom_line(aes(y=cpue, x=year)) +</span></span>
<span><span class="co">#   theme_bw() + labs(y="Brown shrimp CPUE")</span></span>
<span></span>
<span><span class="va">baseplot</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">shrimp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">zone</span><span class="op">~</span><span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">splog</span>, x<span class="op">=</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">splog</span>, x<span class="op">=</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y<span class="op">=</span><span class="st">"log Brown Shrimp CPUE"</span><span class="op">)</span></span>
<span><span class="va">baseplot</span></span></code></pre></div>
<p><img src="hierarchical_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="individual-models">Individual models<a class="anchor" aria-label="anchor" href="#individual-models"></a>
</h2>
<p>For comparison, we will fit models to each population
individually.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zones</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">splags</span><span class="op">$</span><span class="va">zone</span><span class="op">)</span></span>
<span><span class="va">spmodind</span><span class="op">&lt;-</span><span class="va">spmodindout</span><span class="op">&lt;-</span><span class="va">spmodindin</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">zones</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dsub</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">splags</span>, <span class="va">zone</span><span class="op">==</span><span class="va">zones</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">spmodind</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span><span class="va">dsub</span>, y <span class="op">=</span> <span class="st">"splog"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"splog_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">E</span><span class="op">)</span>, </span>
<span>                        pop <span class="op">=</span> <span class="st">"zone"</span>, time <span class="op">=</span> <span class="st">"year"</span>, scaling <span class="op">=</span> <span class="va">scaling</span>, predictmethod <span class="op">=</span> <span class="st">"lto"</span><span class="op">)</span></span>
<span>  <span class="va">spmodindin</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">spmodind</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">insampresults</span></span>
<span>  <span class="va">spmodindout</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">spmodind</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">outsampresults</span></span>
<span><span class="op">}</span></span>
<span><span class="va">spmodindin</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">spmodindin</span><span class="op">)</span></span>
<span><span class="va">spmodindout</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">spmodindout</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">R2indivin</span><span class="op">=</span><span class="fu"><a href="../reference/getR2.html">getR2</a></span><span class="op">(</span><span class="va">spmodindin</span><span class="op">$</span><span class="va">obs</span>,<span class="va">spmodindin</span><span class="op">$</span><span class="va">predmean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8165698</span></span>
<span><span class="op">(</span><span class="va">R2indivout</span><span class="op">=</span><span class="fu"><a href="../reference/getR2.html">getR2</a></span><span class="op">(</span><span class="va">spmodindout</span><span class="op">$</span><span class="va">obs</span>,<span class="va">spmodindout</span><span class="op">$</span><span class="va">predmean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.6121564</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spmodindout</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">=</span><span class="st">"zone"</span></span>
<span></span>
<span><span class="va">baseplot</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Individual"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spmodindout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spmodindout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spmodindout</span>,</span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">timestep</span>, ymin<span class="op">=</span><span class="va">predmean</span><span class="op">-</span><span class="va">predsd</span>,ymax<span class="op">=</span><span class="va">predmean</span><span class="op">+</span><span class="va">predsd</span><span class="op">)</span>,fill<span class="op">=</span><span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 45 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span>
<span><span class="co">#&gt; Warning: Removed 5 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="hierarchical_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="identical-dynamics">Identical dynamics<a class="anchor" aria-label="anchor" href="#identical-dynamics"></a>
</h2>
<p>Including <code>pop</code> and setting <code>rhofixed = 1</code> fits
a multi-population model in which the dynamics of each population are
forced to be identical. In other words, we assume that all delay vectors
come from the same attractor.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmodrho1</span> <span class="op">=</span> <span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span><span class="va">splags</span>, y <span class="op">=</span> <span class="st">"splog"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"splog_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">E</span><span class="op">)</span>, </span>
<span>                  pop <span class="op">=</span> <span class="st">"zone"</span>, rhofixed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  time <span class="op">=</span> <span class="st">"year"</span>, scaling <span class="op">=</span> <span class="va">scaling</span>, predictmethod <span class="op">=</span> <span class="st">"lto"</span><span class="op">)</span></span>
<span><span class="co">#&gt; rhofixed must between 0.0001 and 0.9999, setting to 0.9999</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">spmodrho1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 5 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;      predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1   splog_1       0.06700</span></span>
<span><span class="co">#&gt; phi2   splog_2       0.00120</span></span>
<span><span class="co">#&gt; phi3   splog_3       0.02591</span></span>
<span><span class="co">#&gt; phi4   splog_4       0.10732</span></span>
<span><span class="co">#&gt; phi5   splog_5       0.02019</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.6568221</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 0.5213629</span></span>
<span><span class="co">#&gt; Number of populations: 9</span></span>
<span><span class="co">#&gt; Dynamic correlation (rho): 0.9999</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.6027854 </span></span>
<span><span class="co">#&gt; In-sample R-squared by population:</span></span>
<span><span class="co">#&gt;                 R2</span></span>
<span><span class="co">#&gt; zone11  0.18816256</span></span>
<span><span class="co">#&gt; zone14  0.51847339</span></span>
<span><span class="co">#&gt; zone15  0.25033220</span></span>
<span><span class="co">#&gt; zone16  0.44688137</span></span>
<span><span class="co">#&gt; zone17  0.60331705</span></span>
<span><span class="co">#&gt; zone18  0.52130162</span></span>
<span><span class="co">#&gt; zone19  0.21999381</span></span>
<span><span class="co">#&gt; zone20 -0.06904110</span></span>
<span><span class="co">#&gt; zone21 -0.09802088</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.5555569</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared by population:</span></span>
<span><span class="co">#&gt;                R2</span></span>
<span><span class="co">#&gt; zone11  0.1335001</span></span>
<span><span class="co">#&gt; zone14  0.4542791</span></span>
<span><span class="co">#&gt; zone15  0.1573202</span></span>
<span><span class="co">#&gt; zone16  0.3737063</span></span>
<span><span class="co">#&gt; zone17  0.5488948</span></span>
<span><span class="co">#&gt; zone18  0.4557023</span></span>
<span><span class="co">#&gt; zone19  0.1193898</span></span>
<span><span class="co">#&gt; zone20 -0.1936677</span></span>
<span><span class="co">#&gt; zone21 -0.2132316</span></span>
<span></span>
<span><span class="va">spout</span><span class="op">=</span><span class="va">spmodrho1</span><span class="op">$</span><span class="va">outsampresults</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spout</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">=</span><span class="st">"zone"</span></span>
<span></span>
<span><span class="va">baseplot</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Identical"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>,</span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">timestep</span>, ymin<span class="op">=</span><span class="va">predmean</span><span class="op">-</span><span class="va">predsd</span>,ymax<span class="op">=</span><span class="va">predmean</span><span class="op">+</span><span class="va">predsd</span><span class="op">)</span>,fill<span class="op">=</span><span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 45 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span>
<span><span class="co">#&gt; Warning: Removed 5 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="hierarchical_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>As with other EDM approaches (Simplex, S-map), the same results can
be obtained by simply concatenating the delay vectors for multiple
populations and fitting a standard model, as if the data all came from
one population (i.e. omit the <code>pop</code> argument even though
there are multiple populations). Note that automatic local scaling
cannot be done this way (because only one population is assumed), and
thus any local scaling must be done beforehand. You will also not get
fit stats for each population. To ensure there isn’t crossover between
the end of one time series and the beginning of another when
constructing the delay vectors, this also requires making lags
beforehand and including the <code>pop</code> argument in
<code>makelags</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmod</span> <span class="op">=</span> <span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span><span class="va">splags</span>, y <span class="op">=</span> <span class="st">"splog"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"splog_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">E</span><span class="op">)</span>, </span>
<span>              time <span class="op">=</span> <span class="st">"year"</span>, scaling <span class="op">=</span> <span class="va">scaling</span>, predictmethod <span class="op">=</span> <span class="st">"lto"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#rejoin the zone information (not considered during model fitting)</span></span>
<span><span class="va">spout</span> <span class="op">=</span> <span class="va">spmod</span><span class="op">$</span><span class="va">outsampresults</span></span>
<span><span class="va">spout</span><span class="op">$</span><span class="va">zone</span> <span class="op">=</span> <span class="va">splags</span><span class="op">$</span><span class="va">zone</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="independent-dynamics">Independent dynamics<a class="anchor" aria-label="anchor" href="#independent-dynamics"></a>
</h2>
<p>You can force the populations to have independent dynamics by setting
<code>rhofixed = 0</code>. Note that the populations in this case will
still share the same inverse length scale parameters, so due to this
decreased flexibility, the fit might be poorer than fitting a model to
each population independently.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmodrho0</span> <span class="op">=</span> <span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span><span class="va">splags</span>, y <span class="op">=</span> <span class="st">"splog"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"splog_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">E</span><span class="op">)</span>, </span>
<span>                  pop <span class="op">=</span> <span class="st">"zone"</span>, rhofixed <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                  time <span class="op">=</span> <span class="st">"year"</span>, scaling <span class="op">=</span> <span class="va">scaling</span>, predictmethod <span class="op">=</span> <span class="st">"lto"</span><span class="op">)</span></span>
<span><span class="co">#&gt; rhofixed must between 0.0001 and 0.9999, setting to 0.0001</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">spmodrho0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 5 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;      predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1   splog_1       0.10242</span></span>
<span><span class="co">#&gt; phi2   splog_2       0.30842</span></span>
<span><span class="co">#&gt; phi3   splog_3       0.11504</span></span>
<span><span class="co">#&gt; phi4   splog_4       0.16779</span></span>
<span><span class="co">#&gt; phi5   splog_5       0.17300</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.5720322</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 0.3471291</span></span>
<span><span class="co">#&gt; Number of populations: 9</span></span>
<span><span class="co">#&gt; Dynamic correlation (rho): 1e-04</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.7190166 </span></span>
<span><span class="co">#&gt; In-sample R-squared by population:</span></span>
<span><span class="co">#&gt;               R2</span></span>
<span><span class="co">#&gt; zone11 0.3566795</span></span>
<span><span class="co">#&gt; zone14 0.6152239</span></span>
<span><span class="co">#&gt; zone15 0.4512542</span></span>
<span><span class="co">#&gt; zone16 0.6093629</span></span>
<span><span class="co">#&gt; zone17 0.6780450</span></span>
<span><span class="co">#&gt; zone18 0.6445697</span></span>
<span><span class="co">#&gt; zone19 0.4516270</span></span>
<span><span class="co">#&gt; zone20 0.3520710</span></span>
<span><span class="co">#&gt; zone21 0.3915480</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.5287102</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared by population:</span></span>
<span><span class="co">#&gt;                 R2</span></span>
<span><span class="co">#&gt; zone11 -0.03022679</span></span>
<span><span class="co">#&gt; zone14  0.37914299</span></span>
<span><span class="co">#&gt; zone15  0.05440260</span></span>
<span><span class="co">#&gt; zone16  0.33830490</span></span>
<span><span class="co">#&gt; zone17  0.51555075</span></span>
<span><span class="co">#&gt; zone18  0.40588994</span></span>
<span><span class="co">#&gt; zone19  0.02939522</span></span>
<span><span class="co">#&gt; zone20 -0.10142623</span></span>
<span><span class="co">#&gt; zone21 -0.13070247</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hierarchical-dynamics-single-rho">Hierarchical dynamics (single rho)<a class="anchor" aria-label="anchor" href="#hierarchical-dynamics-single-rho"></a>
</h2>
<p>To allow for information sharing across populations without assuming
the dynamics are identical, we can fit a hierarchical model with a free
<code>rho</code> parameter. Simply omit the <code>rhofixed</code>
argument, and <code>rho</code> will be estimated.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmodrho</span> <span class="op">=</span> <span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span><span class="va">splags</span>, y <span class="op">=</span> <span class="st">"splog"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"splog_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">E</span><span class="op">)</span>, </span>
<span>                 pop <span class="op">=</span> <span class="st">"zone"</span>,</span>
<span>                 time <span class="op">=</span> <span class="st">"year"</span>, scaling <span class="op">=</span> <span class="va">scaling</span>, predictmethod <span class="op">=</span> <span class="st">"lto"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">spmodrho</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 5 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;      predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1   splog_1       0.13002</span></span>
<span><span class="co">#&gt; phi2   splog_2       0.00000</span></span>
<span><span class="co">#&gt; phi3   splog_3       0.06131</span></span>
<span><span class="co">#&gt; phi4   splog_4       0.17783</span></span>
<span><span class="co">#&gt; phi5   splog_5       0.03767</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.6467111</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 0.2658343</span></span>
<span><span class="co">#&gt; Number of populations: 9</span></span>
<span><span class="co">#&gt; Dynamic correlation (rho): 0.9169996</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.6193695 </span></span>
<span><span class="co">#&gt; In-sample R-squared by population:</span></span>
<span><span class="co">#&gt;                 R2</span></span>
<span><span class="co">#&gt; zone11  0.20436617</span></span>
<span><span class="co">#&gt; zone14  0.53323690</span></span>
<span><span class="co">#&gt; zone15  0.25772910</span></span>
<span><span class="co">#&gt; zone16  0.46958275</span></span>
<span><span class="co">#&gt; zone17  0.63364240</span></span>
<span><span class="co">#&gt; zone18  0.53115126</span></span>
<span><span class="co">#&gt; zone19  0.26551303</span></span>
<span><span class="co">#&gt; zone20 -0.01321866</span></span>
<span><span class="co">#&gt; zone21 -0.03786475</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.5532995</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared by population:</span></span>
<span><span class="co">#&gt;                R2</span></span>
<span><span class="co">#&gt; zone11  0.1029215</span></span>
<span><span class="co">#&gt; zone14  0.4470370</span></span>
<span><span class="co">#&gt; zone15  0.1252973</span></span>
<span><span class="co">#&gt; zone16  0.3732042</span></span>
<span><span class="co">#&gt; zone17  0.5673172</span></span>
<span><span class="co">#&gt; zone18  0.4386862</span></span>
<span><span class="co">#&gt; zone19  0.1240376</span></span>
<span><span class="co">#&gt; zone20 -0.1858376</span></span>
<span><span class="co">#&gt; zone21 -0.2057786</span></span>
<span></span>
<span><span class="va">spout</span><span class="op">=</span><span class="va">spmodrho</span><span class="op">$</span><span class="va">outsampresults</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spout</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">=</span><span class="st">"zone"</span></span>
<span></span>
<span><span class="va">baseplot</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Hierarchical"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>,</span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">timestep</span>, ymin<span class="op">=</span><span class="va">predmean</span><span class="op">-</span><span class="va">predsd</span>,ymax<span class="op">=</span><span class="va">predmean</span><span class="op">+</span><span class="va">predsd</span><span class="op">)</span>,fill<span class="op">=</span><span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 45 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span>
<span><span class="co">#&gt; Warning: Removed 5 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="hierarchical_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="hierarchical-dynamics-rho-matrix">Hierarchical dynamics (rho matrix)<a class="anchor" aria-label="anchor" href="#hierarchical-dynamics-rho-matrix"></a>
</h2>
<p>Instead of using a single <code>rho</code> value, a matrix of fixed
pairwise rho values can be supplied using <code>rhomatrix.</code> In
this case, the single rho parameter will not be used and will revert to
the mode of its prior (~0.5). A pairwise rho matrix can be generated
using <code>getrhomatrix</code>, or you can create a custom one
(e.g. based on geographical distance). All <code>getrhomatrix</code>
does is fit a hierarchical model to each pair of populations and put the
resulting <code>rho</code> values in a matrix that can be passed to
<code>fitGP</code>. The rhomatrix itself can be informative about
dynamic similarity among populations, and reveal potential clustering
and spatial structure.</p>
<p>If you get an error that the matrix is not positive definite (which
can happen), you can use <code><a href="https://rdrr.io/pkg/Matrix/man/nearPD.html" class="external-link">Matrix::nearPD()</a></code> with
<code>corr=TRUE</code> to obtain a positive definite matrix close to
<code>rhomatrix</code>. The function <code><a href="../reference/posdef.html">GPEDM::posdef()</a></code> is a
quick wrapper for this.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Rhomat</span> <span class="op">=</span> <span class="fu"><a href="../reference/getrhomatrix.html">getrhomatrix</a></span><span class="op">(</span><span class="va">splags</span>, y <span class="op">=</span> <span class="st">"splog"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"splog_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">E</span><span class="op">)</span>, </span>
<span>                      pop <span class="op">=</span> <span class="st">"zone"</span>,</span>
<span>                      time <span class="op">=</span> <span class="st">"year"</span>, scaling <span class="op">=</span> <span class="va">scaling</span><span class="op">)</span></span>
<span><span class="va">Rhomat</span></span>
<span><span class="co">#&gt;           zone11    zone14    zone15    zone16    zone17    zone18    zone19</span></span>
<span><span class="co">#&gt; zone11 1.0000000 0.6976526 0.6244876 0.6422882 0.7827404 0.8218578 0.7974962</span></span>
<span><span class="co">#&gt; zone14 0.6976526 1.0000000 0.8102220 0.8576069 0.8259549 0.8253132 0.8244647</span></span>
<span><span class="co">#&gt; zone15 0.6244876 0.8102220 1.0000000 0.7847154 0.8313152 0.8528488 0.7430921</span></span>
<span><span class="co">#&gt; zone16 0.6422882 0.8576069 0.7847154 1.0000000 0.8312329 0.5110798 0.7345495</span></span>
<span><span class="co">#&gt; zone17 0.7827404 0.8259549 0.8313152 0.8312329 1.0000000 0.7535192 0.6125335</span></span>
<span><span class="co">#&gt; zone18 0.8218578 0.8253132 0.8528488 0.5110798 0.7535192 1.0000000 0.8547646</span></span>
<span><span class="co">#&gt; zone19 0.7974962 0.8244647 0.7430921 0.7345495 0.6125335 0.8547646 1.0000000</span></span>
<span><span class="co">#&gt; zone20 0.6253667 0.6009822 0.3716549 0.6315166 0.4731135 0.2439610 0.5750741</span></span>
<span><span class="co">#&gt; zone21 0.4844173 0.4282931 0.3838596 0.2655707 0.3700907 0.5366677 0.3783972</span></span>
<span><span class="co">#&gt;           zone20    zone21</span></span>
<span><span class="co">#&gt; zone11 0.6253667 0.4844173</span></span>
<span><span class="co">#&gt; zone14 0.6009822 0.4282931</span></span>
<span><span class="co">#&gt; zone15 0.3716549 0.3838596</span></span>
<span><span class="co">#&gt; zone16 0.6315166 0.2655707</span></span>
<span><span class="co">#&gt; zone17 0.4731135 0.3700907</span></span>
<span><span class="co">#&gt; zone18 0.2439610 0.5366677</span></span>
<span><span class="co">#&gt; zone19 0.5750741 0.3783972</span></span>
<span><span class="co">#&gt; zone20 1.0000000 0.5239022</span></span>
<span><span class="co">#&gt; zone21 0.5239022 1.0000000</span></span>
<span></span>
<span><span class="co">#plot the rho matrix</span></span>
<span><span class="va">Rmatlong</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">as.table</a></span><span class="op">(</span><span class="va">Rhomat</span><span class="op">)</span><span class="op">)</span> <span class="co">#for plotting purposes only</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Rmatlong</span><span class="op">)</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Region1"</span>, <span class="st">"Region2"</span>, <span class="st">"rho"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Rmatlong</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Region1</span>, y<span class="op">=</span><span class="va">Region2</span>, fill<span class="op">=</span><span class="va">rho</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_y_discrete</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"gray"</span><span class="op">)</span>, </span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"black"</span>, fill<span class="op">=</span><span class="st">"transparent"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="hierarchical_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">Rhomatpd</span><span class="op">=</span><span class="fu"><a href="../reference/posdef.html">posdef</a></span><span class="op">(</span><span class="va">Rhomat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spmodrhomat</span> <span class="op">=</span> <span class="fu"><a href="../reference/fitGP.html">fitGP</a></span><span class="op">(</span><span class="va">splags</span>, y <span class="op">=</span> <span class="st">"splog"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"splog_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">E</span><span class="op">)</span>, </span>
<span>                    pop <span class="op">=</span> <span class="st">"zone"</span>, rhomatrix <span class="op">=</span> <span class="va">Rhomatpd</span>,</span>
<span>                    time <span class="op">=</span> <span class="st">"year"</span>, scaling <span class="op">=</span> <span class="va">scaling</span>, predictmethod <span class="op">=</span> <span class="st">"lto"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">spmodrhomat</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of predictors: 5 </span></span>
<span><span class="co">#&gt; Length scale parameters:</span></span>
<span><span class="co">#&gt;      predictor posteriormode</span></span>
<span><span class="co">#&gt; phi1   splog_1       0.20552</span></span>
<span><span class="co">#&gt; phi2   splog_2       0.01286</span></span>
<span><span class="co">#&gt; phi3   splog_3       0.06446</span></span>
<span><span class="co">#&gt; phi4   splog_4       0.22136</span></span>
<span><span class="co">#&gt; phi5   splog_5       0.07911</span></span>
<span><span class="co">#&gt; Process variance (ve): 0.5900952</span></span>
<span><span class="co">#&gt; Pointwise prior variance (sigma2): 0.2670027</span></span>
<span><span class="co">#&gt; Number of populations: 9</span></span>
<span><span class="co">#&gt; Dynamic correlation (rho): rhomatrix</span></span>
<span><span class="co">#&gt; In-sample R-squared: 0.6712945 </span></span>
<span><span class="co">#&gt; In-sample R-squared by population:</span></span>
<span><span class="co">#&gt;               R2</span></span>
<span><span class="co">#&gt; zone11 0.2387228</span></span>
<span><span class="co">#&gt; zone14 0.5907084</span></span>
<span><span class="co">#&gt; zone15 0.3096061</span></span>
<span><span class="co">#&gt; zone16 0.5500649</span></span>
<span><span class="co">#&gt; zone17 0.6919789</span></span>
<span><span class="co">#&gt; zone18 0.6146147</span></span>
<span><span class="co">#&gt; zone19 0.3616301</span></span>
<span><span class="co">#&gt; zone20 0.1190174</span></span>
<span><span class="co">#&gt; zone21 0.1880890</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared: 0.5642167</span></span>
<span><span class="co">#&gt; Out-of-sample R-squared by population:</span></span>
<span><span class="co">#&gt;                 R2</span></span>
<span><span class="co">#&gt; zone11  0.05478630</span></span>
<span><span class="co">#&gt; zone14  0.47564667</span></span>
<span><span class="co">#&gt; zone15  0.09787071</span></span>
<span><span class="co">#&gt; zone16  0.39897111</span></span>
<span><span class="co">#&gt; zone17  0.60659794</span></span>
<span><span class="co">#&gt; zone18  0.47556592</span></span>
<span><span class="co">#&gt; zone19  0.14990686</span></span>
<span><span class="co">#&gt; zone20 -0.20415259</span></span>
<span><span class="co">#&gt; zone21 -0.15334904</span></span>
<span></span>
<span><span class="va">spout</span><span class="op">=</span><span class="va">spmodrhomat</span><span class="op">$</span><span class="va">outsampresults</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spout</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">=</span><span class="st">"zone"</span></span>
<span></span>
<span><span class="va">baseplot</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Hierarchical Matrix"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmean</span>, x<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">spout</span>,</span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">timestep</span>, ymin<span class="op">=</span><span class="va">predmean</span><span class="op">-</span><span class="va">predsd</span>,ymax<span class="op">=</span><span class="va">predmean</span><span class="op">+</span><span class="va">predsd</span><span class="op">)</span>,fill<span class="op">=</span><span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 45 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span>
<span><span class="co">#&gt; Warning: Removed 5 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="hierarchical_files/figure-html/unnamed-chunk-8-2.png" width="700"></p>
<div class="section level4">
<h4 id="compare-models">Compare models<a class="anchor" aria-label="anchor" href="#compare-models"></a>
</h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Individual"</span>, <span class="st">"Independent"</span>, <span class="st">"Identical"</span>, <span class="st">"Single rho"</span>, <span class="st">"Rho matrix"</span><span class="op">)</span>,</span>
<span>                      InSampR2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">R2indivin</span>,</span>
<span>                                 <span class="va">spmodrho0</span><span class="op">$</span><span class="va">insampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span>,</span>
<span>                                 <span class="va">spmodrho1</span><span class="op">$</span><span class="va">insampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span>,</span>
<span>                                 <span class="va">spmodrho</span><span class="op">$</span><span class="va">insampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span>,</span>
<span>                                 <span class="va">spmodrhomat</span><span class="op">$</span><span class="va">insampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                      OutSampR2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">R2indivout</span>,</span>
<span>                                  <span class="va">spmodrho0</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span>,</span>
<span>                                  <span class="va">spmodrho1</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span>,</span>
<span>                                  <span class="va">spmodrho</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span>,</span>
<span>                                  <span class="va">spmodrhomat</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">comparison</span></span>
<span><span class="co">#&gt;         Model  InSampR2 OutSampR2</span></span>
<span><span class="co">#&gt; 1  Individual 0.8165698 0.6121564</span></span>
<span><span class="co">#&gt; 2 Independent 0.7190166 0.5287102</span></span>
<span><span class="co">#&gt; 3   Identical 0.6027854 0.5555569</span></span>
<span><span class="co">#&gt; 4  Single rho 0.6193695 0.5532995</span></span>
<span><span class="co">#&gt; 5  Rho matrix 0.6712945 0.5642167</span></span>
<span></span>
<span><span class="va">popcomparison</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Individual<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">spmodind</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">outsampfitstats</span><span class="op">[</span><span class="st">"R2"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                         Independent<span class="op">=</span><span class="va">spmodrho0</span><span class="op">$</span><span class="va">outsampfitstatspop</span><span class="op">$</span><span class="va">R2pop</span>,</span>
<span>                         Identical<span class="op">=</span><span class="va">spmodrho1</span><span class="op">$</span><span class="va">outsampfitstatspop</span><span class="op">$</span><span class="va">R2pop</span>,</span>
<span>                         Single_rho<span class="op">=</span><span class="va">spmodrho</span><span class="op">$</span><span class="va">outsampfitstatspop</span><span class="op">$</span><span class="va">R2pop</span>,</span>
<span>                         Rho_matrix<span class="op">=</span><span class="va">spmodrhomat</span><span class="op">$</span><span class="va">outsampfitstatspop</span><span class="op">$</span><span class="va">R2pop</span><span class="op">)</span></span>
<span><span class="va">popcomparison</span></span>
<span><span class="co">#&gt;         Individual Independent  Identical Single_rho  Rho_matrix</span></span>
<span><span class="co">#&gt; zone11 0.087608203 -0.03022679  0.1335001  0.1029215  0.05478630</span></span>
<span><span class="co">#&gt; zone14 0.412489699  0.37914299  0.4542791  0.4470370  0.47564667</span></span>
<span><span class="co">#&gt; zone15 0.193900661  0.05440260  0.1573202  0.1252973  0.09787071</span></span>
<span><span class="co">#&gt; zone16 0.479309505  0.33830490  0.3737063  0.3732042  0.39897111</span></span>
<span><span class="co">#&gt; zone17 0.605466183  0.51555075  0.5488948  0.5673172  0.60659794</span></span>
<span><span class="co">#&gt; zone18 0.603964931  0.40588994  0.4557023  0.4386862  0.47556592</span></span>
<span><span class="co">#&gt; zone19 0.341658106  0.02939522  0.1193898  0.1240376  0.14990686</span></span>
<span><span class="co">#&gt; zone20 0.086590821 -0.10142623 -0.1936677 -0.1858376 -0.20415259</span></span>
<span><span class="co">#&gt; zone21 0.006953901 -0.13070247 -0.2132316 -0.2057786 -0.15334904</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Munch, S. B., Poynor, V., and Arriaza, J. L. 2017. Circumventing
structural uncertainty: a Bayesian perspective on nonlinear forecasting
for ecology. Ecological Complexity, 32:134.</p>
<p>Rogers, T. L., and Munch, S. B. 2020. Hidden similarities in the
dynamics of a weakly synchronous marine metapopulation. Proceedings in
the National Academy of Science, 117(1), 479–485.</p>
<p>Tsai, C. H., Munch, S. B., Masi, M. D., and Pollack, A. G. 2022.
Predicting nonlinear dynamics of short-lived penaeid shrimp species in
the Gulf of Mexico. Canadian Journal of Fisheries and Aquatic
Sciences.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Stephan Munch, Tanya Rogers.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
